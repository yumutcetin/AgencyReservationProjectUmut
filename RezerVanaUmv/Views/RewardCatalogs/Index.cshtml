@model IEnumerable<dynamic>

@{
    ViewData["Title"] = "🎁 Kazanç Puanları Gecelik";
    Layout = "~/Views/PageViews/UserLayout.cshtml";
}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<h2 class="mb-3">🎁 @RezerVanaUmv.Resources.Resource.Oda_Tipine_Göre</h2>
<hr />

@Html.AntiForgeryToken()

@{
    // dynamic için güvenli ISO formatter (yyyy-MM-dd)
    Func<object, string> ToIso = (object dt) =>
    {
        if (dt == null) return "";
        try
        {
            if (dt is DateTime d) return d.ToString("yyyy-MM-dd");
            if (dt is DateTimeOffset dto) return dto.DateTime.ToString("yyyy-MM-dd");
            var s = dt.ToString();
            if (DateTime.TryParse(s, out var parsed)) return parsed.ToString("yyyy-MM-dd");
            return "";
        }
        catch { return ""; }
    };

    // dynamic + lambda sorunlarını önlemek için listeye al
    var modelList = Model != null ? Model.ToList() : new List<dynamic>();
}

<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>@RezerVanaUmv.Resources.Resource.Oda_Tipi</th>
                <th>Gece</th>
                <th>@RezerVanaUmv.Resources.Resource.İşlemler</th>
            </tr>
        </thead>
        <tbody>
            @for (var index = 0; index < modelList.Count; index++)
            {
                var item = modelList[index];
                var roomTypeStr = (item.RoomType ?? "").ToString();
                var roomKey = roomTypeStr.Replace(" ", "-").Replace("/", "-").Replace("'", "").Replace("\"", "");
                var modalId = $"modal-{roomKey}-{index}";
                <tr>
                    <td>@roomTypeStr</td>
                    <td>1</td>
                    <td>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#@modalId">
                            ✏️ @RezerVanaUmv.Resources.Resource.Edit
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @for (var index = 0; index < modelList.Count; index++)
    {
        var item = modelList[index];
        var roomTypeStr = (item.RoomType ?? "").ToString();
        var roomKey = roomTypeStr.Replace(" ", "-").Replace("/", "-").Replace("'", "").Replace("\"", "");
        var modalId = $"modal-{roomKey}-{index}";

        <div class="modal fade" id="@modalId" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@roomTypeStr @RezerVanaUmv.Resources.Resource.Dönemleri</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>@RezerVanaUmv.Resources.Resource.Start_Date</th>
                                    <th>@RezerVanaUmv.Resources.Resource.End_Date</th>
                                    <th>@RezerVanaUmv.Resources.Resource.Puan</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="periods-@roomKey">
                                @if (item.Periods != null)
                                {
                                    foreach (var period in item.Periods)
                                    {
                                        <tr>
                                            <!-- span YOK; sadece native date input. value: yyyy-MM-dd -->
                                            <td><input type="date" class="form-control" value="@ToIso(period.StartDate)" /></td>
                                            <td><input type="date" class="form-control" value="@ToIso(period.EndDate)" /></td>
                                            <td><input type="number" class="form-control" value="@(period.RequiredPoints ?? 0)" min="1" /></td>
                                            <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">🗑️</button></td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addPeriodRow('@roomKey')">➕ @RezerVanaUmv.Resources.Resource.Dönem_Ekle</button>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@RezerVanaUmv.Resources.Resource.İptal</button>
                        <button type="button" class="btn btn-primary save-periods-btn" data-roomtype="@roomTypeStr">
                            @RezerVanaUmv.Resources.Resource.KAYDET
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        /* ===== Yardımcılar ===== */
        function showModalAlert(modalEl, type, text) {
            const body = modalEl.querySelector('.modal-body');
            let host = modalEl.querySelector('.modal-alert');
            if (!host) { host = document.createElement('div'); host.className = 'modal-alert'; body.prepend(host); }
            host.innerHTML = `<div class="alert alert-${type} mb-3" role="alert">${text}</div>`;
            setTimeout(() => { host.innerHTML = ''; }, 3000);
        }

        // Basit validasyon + çakışma kontrolü
        function validatePeriods(periods) {
            if (periods.length === 0) return "@RezerVanaUmv.Resources.Resource.Dönem_Ekle"; // en az bir dönem
            if (periods.some(p => !p.startDate || !p.endDate || isNaN(p.requiredPoints) || p.requiredPoints <= 0)) {
                return "Lütfen_Tüm_Alanları_Doldurun";
            }
            const sorted = periods
                .map(p => ({...p, s: new Date(p.startDate), e: new Date(p.endDate)}))
                .sort((a,b) => a.s - b.s);

            for (let i=0;i<sorted.length-1;i++) {
                if (sorted[i].e >= sorted[i+1].s) {
                    return "Dönem_Çakışması";
                }
            }
            return null;
        }

        /* ===== Satır ekle ===== */
        function addPeriodRow(roomKey) {
            const tbody = document.querySelector(`#periods-${roomKey}`);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="date" class="form-control" /></td>
                <td><input type="date" class="form-control" /></td>
                <td><input type="number" class="form-control" min="1" /></td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">🗑️</button></td>
            `;
            tbody.appendChild(row);
        }
        window.addPeriodRow = addPeriodRow;

        /* ===== Kaydet (modal bazlı) ===== */
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.save-periods-btn');
            if (!btn) return;

            const modalEl = btn.closest('.modal');
            const roomType = btn.getAttribute('data-roomtype');

            const tbody = modalEl.querySelector('tbody');
            const rows = tbody ? tbody.querySelectorAll('tr') : [];

            const periods = Array.from(rows).map(row => {
                const [startInp, endInp, pointInp] = row.querySelectorAll('input');
                return {
                    startDate: startInp?.value || '',
                    endDate: endInp?.value || '',
                    requiredPoints: parseInt(pointInp?.value) || 0
                };
            });

            const err = validatePeriods(periods);
            if (err) { showModalAlert(modalEl, 'warning', err); return; }

            const tokenEl = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenEl ? tokenEl.value : null;

            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'Kaydediliyor...';

            try {
                const resp = await fetch('/RewardCatalogs/UpdatePeriods', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token ? { 'RequestVerificationToken': token } : {})
                    },
                    body: JSON.stringify({ roomType, periods })
                });

                if (resp.ok) {
                    showModalAlert(modalEl, 'success', 'Kaydedildi!');
                } else {
                    const t = await resp.text();
                    showModalAlert(modalEl, 'danger', 'Kaydedilirken hata oluştu. ' + (t || ''));
                }
            } catch (ex) {
                showModalAlert(modalEl, 'danger', 'İstek gönderilemedi. ' + ex.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });
    </script>
}
